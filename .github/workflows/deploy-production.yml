name: ğŸš€ Deploy to Production (Manual)

# This workflow implements safe, manual production deployment
# Following Phase 2 Week 5 requirements: "Production deployment remains manual for safety"

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY-TO-PRODUCTION" to confirm'
        required: true
        type: string
      deployment_reason:
        description: 'Reason for production deployment'
        required: true
        type: string

jobs:
  validate-input:
    name: ğŸ” Validate Deployment Request
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate confirmation input
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY-TO-PRODUCTION" ]; then
            echo "âŒ Invalid confirmation. Please type 'DEPLOY-TO-PRODUCTION' exactly"
            echo "ğŸ”’ This safety check prevents accidental production deployments"
            exit 1
          fi
          
          if [ -z "${{ github.event.inputs.deployment_reason }}" ]; then
            echo "âŒ Deployment reason is required"
            echo "ğŸ“ Please provide a clear reason for this production deployment"
            exit 1
          fi
          
      - name: ğŸ“‹ Deployment Details
        run: |
          echo "ğŸ¯ **PRODUCTION DEPLOYMENT REQUEST**"
          echo "ğŸ‘¤ Requested by: ${{ github.actor }}"
          echo "ğŸŒ¿ Source branch: ${{ github.ref_name }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "ğŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  pre-deployment-tests:
    name: ğŸ§ª Pre-Deployment Testing
    runs-on: ubuntu-latest
    needs: validate-input
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run full test suite
        run: npm test
        
      - name: ğŸ—ï¸ Validate production configuration
        run: |
          echo "ğŸ” Validating wrangler.toml for production..."
          if [ -f "wrangler.toml" ]; then
            echo "âœ… wrangler.toml found"
            
            # Check for required production settings
            if grep -q "APP_ENV.*production" wrangler.toml; then
              echo "âœ… Production environment configured"
            else
              echo "âŒ Production environment not properly configured"
              exit 1
            fi
            
            if grep -q "LOG_LEVEL.*error" wrangler.toml; then
              echo "âœ… Production log level configured"
            else
              echo "âš ï¸ Consider setting LOG_LEVEL to 'error' for production"
            fi
          else
            echo "âŒ wrangler.toml missing"
            exit 1
          fi

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate-input, pre-deployment-tests]
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸš¨ Final Production Warning
        run: |
          echo "âš ï¸ âš ï¸ âš ï¸ PRODUCTION DEPLOYMENT STARTING âš ï¸ âš ï¸ âš ï¸"
          echo ""
          echo "ğŸ¯ Target: bx-app-quotation-generator (Production)"
          echo "ğŸ‘¤ Deployer: ${{ github.actor }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.deployment_reason }}"
          echo ""
          echo "ğŸ“‹ Pre-deployment checklist:"
          echo "  âœ… Tests passed"
          echo "  âœ… Configuration validated"
          echo "  âœ… Manual confirmation provided"
          echo ""
          sleep 5
          
      - name: ğŸš€ Deploy to Production
        run: npm run deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: ğŸ‰ Production Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Production deployment completed successfully!"
          echo ""
          echo "ğŸŒ Production URL: https://bx-app-quotation-generator.{account}.workers.dev"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ“ Deployment reason: ${{ github.event.inputs.deployment_reason }}"
          echo "ğŸ• Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“‹ Post-deployment actions:"
          echo "  ğŸ” Monitor application logs: npm run tail:prod"  
          echo "  ğŸ§ª Run smoke tests on production URL"
          echo "  ğŸ“Š Check Cloudflare analytics for traffic/errors"
          echo "  ğŸš¨ Monitor for any user-reported issues"
          echo ""
          echo "ğŸ”„ Rollback instructions (if needed):"
          echo "  1. Identify previous working commit: git log --oneline"
          echo "  2. Checkout to working commit: git checkout <commit-hash>"
          echo "  3. Redeploy: npm run deploy:prod"
          
      - name: ğŸš¨ Production Deployment Failed
        if: failure()
        run: |
          echo "âŒ Production deployment failed!"
          echo ""
          echo "ğŸ”§ Immediate actions required:"
          echo "  1. Check deployment logs above for error details"
          echo "  2. Verify Cloudflare secrets are correctly configured"
          echo "  3. Test deployment locally: npm run deploy:prod"
          echo "  4. If urgent, consider rolling back to previous version"
          echo ""
          echo "ğŸ†˜ Emergency rollback:"
          echo "  1. Identify last working production commit"
          echo "  2. Deploy manually: git checkout <working-commit> && npm run deploy:prod"
          echo ""
          echo "ğŸ“ Contact information:"
          echo "  - Check application monitoring dashboards"
          echo "  - Review Cloudflare Workers logs"
          echo "  - Notify development team of deployment failure"

  post-deployment:
    name: ğŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ“ˆ **Production Deployment Summary**"
          echo ""
          echo "âœ… **Status**: Successfully Deployed"
          echo "ğŸ‘¤ **Deployed by**: ${{ github.actor }}"  
          echo "ğŸŒ¿ **Branch**: ${{ github.ref_name }}"
          echo "ğŸ“ **Reason**: ${{ github.event.inputs.deployment_reason }}"
          echo "ğŸ• **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ¯ **Next Steps**:"
          echo "  1. Monitor production logs for 15-30 minutes"
          echo "  2. Verify key application functions work correctly"  
          echo "  3. Check for any error spikes in monitoring"
          echo "  4. Update team on deployment status"
          echo ""
          echo "ğŸ“‹ **Monitoring Commands**:"
          echo "  â€¢ Production logs: \`npm run tail:prod\`"
          echo "  â€¢ Local testing: \`npm run dev:prod\`"