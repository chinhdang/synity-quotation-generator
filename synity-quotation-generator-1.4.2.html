<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Tạo Báo Giá - SYNITY v1.4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .form-section {
            background-color: #FFFFFF;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .form-section h2 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0D9488;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        input, select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #0D9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
        }
        input[readonly], select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .action-button {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 700;
            color: white;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .installment-value {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            text-align: right;
        }
        
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
        }
        
        .toggle-switch input:checked + div > div:first-child {
            background-color: #0D9488;
        }
        
        .toggle-switch input:checked + div > div:last-child {
            transform: translateX(100%);
        }
        
        .toggle-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col lg:flex-row h-screen">
        <!-- Left Column: Control Panel -->
        <div class="w-full lg:w-1/3 p-4 overflow-y-auto">
            <div class="space-y-6">
                <div class="text-center p-4 bg-white rounded-lg shadow">
                     <img src="https://placehold.co/120x40/0D9488/FFFFFF?text=SYNITY" alt="Logo SYNITY" class="h-10 mx-auto mb-2">
                    <h1 class="text-2xl font-bold text-gray-800">Trình Tạo Báo Giá</h1>
                </div>

                <!-- Form Sections -->
                <div class="form-section">
                    <h2>1. Thông Tin Người Thực Hiện</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="responsiblePersonName">Họ và tên</label>
                            <input type="text" id="responsiblePersonName" value="Chinh Đặng">
                        </div>
                        <div>
                            <label for="responsiblePersonPhone">Số điện thoại</label>
                            <input type="tel" id="responsiblePersonPhone" value="0947100700">
                        </div>
                        <div>
                            <label for="responsiblePersonEmail">Email</label>
                            <input type="email" id="responsiblePersonEmail" value="chinh@synity.vn">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>2. Thông Tin Khách Hàng</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="clientCompanyName">Tên công ty khách hàng</label>
                            <input type="text" id="clientCompanyName" value="Công ty TNHH ABC">
                        </div>
                        <div>
                            <label for="client_address">Địa chỉ công ty</label>
                            <input type="text" id="client_address" value="123 Đường ABC, Phường 1, Quận 2, TP. HCM">
                        </div>
                        <div>
                            <label for="client_tax_code">Mã số thuế</label>
                            <input type="text" id="client_tax_code" value="0312345678">
                        </div>
                        <div>
                            <label for="contact_name">Người liên hệ</label>
                            <input type="text" id="contact_name" value="Nguyễn Văn A">
                        </div>
                         <div>
                            <label for="contact_phone">SĐT người liên hệ</label>
                            <input type="tel" id="contact_phone" value="0123456789">
                        </div>
                        <div>
                            <label for="contact_email">Email người liên hệ</label>
                            <input type="email" id="contact_email" value="contact@abccompany.com">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>3. Thông Tin Báo Giá</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quotation_number">Số báo giá</label>
                            <input type="text" id="quotation_number" value="">
                        </div>
                        <div>
                            <label for="date_created">Ngày tạo</label>
                            <input type="date" id="date_created">
                        </div>
                        <div>
                            <label for="closed_date">Hiệu lực đến</label>
                            <input type="date" id="closed_date">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>4. Sản Phẩm & Dịch Vụ</h2>
                    <div class="space-y-4">
                        <fieldset class="border p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <legend class="text-lg font-semibold px-2">A. Bản quyền Bitrix24</legend>
                                <label class="flex items-center cursor-pointer toggle-switch">
                                    <input type="checkbox" id="include_bitrix_license" class="sr-only" checked>
                                    <div class="relative">
                                        <div class="w-12 h-6 bg-gray-300 rounded-full shadow-inner transition-colors duration-200"></div>
                                        <div class="absolute left-0 top-0 w-6 h-6 bg-white rounded-full shadow transform transition-transform duration-200 translate-x-0"></div>
                                    </div>
                                    <span class="ml-3 text-sm text-gray-700">Bao gồm bản quyền</span>
                                </label>
                            </div>
                            <div id="bitrix_license_container" class="space-y-4 mt-2">
                                <div>
                                    <label for="bitrix_version_select">Chọn phiên bản</label>
                                    <select id="bitrix_version_select"></select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="bitrix_price_usd">Giá (USD/tháng)</label>
                                        <input type="number" id="bitrix_price_usd" readonly>
                                    </div>
                                    <div>
                                        <label for="bitrix_months">Số tháng</label>
                                        <input type="text" id="bitrix_months" readonly>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="border-t pt-4 mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-lg font-semibold text-gray-800">B. Phí Triển Khai & Đồng Hành</label>
                                <label class="flex items-center cursor-pointer toggle-switch">
                                    <input type="checkbox" id="include_implementation_fee" class="sr-only" checked>
                                    <div class="relative">
                                        <div class="w-12 h-6 bg-gray-300 rounded-full shadow-inner transition-colors duration-200"></div>
                                        <div class="absolute left-0 top-0 w-6 h-6 bg-white rounded-full shadow transform transition-transform duration-200 translate-x-0"></div>
                                    </div>
                                    <span class="ml-3 text-sm text-gray-700">Bao gồm phí triển khai</span>
                                </label>
                            </div>
                            <div id="implementation_fee_container">
                                <label for="implementation_fee">Phí triển khai & đồng hành (VNĐ)</label>
                                <input type="number" id="implementation_fee" value="392000000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>5. Tham Số Tính Toán</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="exchange_rate">Tỷ giá USD/VND</label>
                                <input type="number" id="exchange_rate" value="26500">
                            </div>
                            <div>
                                <label for="currency_conversion_fee_percent">Phí chuyển đổi ngoại tệ (%)</label>
                                <input type="number" id="currency_conversion_fee_percent" value="3" min="0" max="100" step="0.1">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="discount_percent">Tổng ưu đãi (%)</label>
                                <input type="number" id="discount_percent" value="10" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>6. Tiến Độ Thanh Toán (Phí Triển Khai)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="payment_installments">Số đợt thanh toán</label>
                                <select id="payment_installments">
                                    <option value="1">1 đợt</option>
                                    <option value="2" selected>2 đợt</option>
                                    <option value="3">3 đợt</option>
                                </select>
                            </div>
                            <div>
                                <label>Phương thức chia</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <label class="flex items-center"><input type="radio" name="payment_split_method" value="percent" checked class="mr-1"> Theo %</label>
                                    <label class="flex items-center"><input type="radio" name="payment_split_method" value="amount" class="mr-1"> Theo VNĐ</label>
                                </div>
                            </div>
                        </div>
                        <div id="installments_details_container" class="space-y-3">
                        </div>
                        <div id="installments_validation_message" class="text-sm font-semibold text-center p-2 rounded-md"></div>
                        <div class="border-t pt-4">
                            <label for="merge_payments_checkbox" class="flex items-center cursor-pointer">
                                <input type="checkbox" id="merge_payments_checkbox" class="mr-2 h-4 w-4 rounded">
                                <span>Gộp Phí bản quyền (A) vào Đợt 1</span>
                            </label>
                        </div>
                    </div>
                </div>


                <!-- Action Buttons -->
                <div class="space-y-4 pt-4">
                    <button id="generate-btn" class="action-button bg-blue-600 hover:bg-blue-700">Tạo / Cập Nhật Báo Giá</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="export-btn" class="action-button bg-teal-600 hover:bg-teal-700">Xuất File HTML</button>
                        <button id="export-pdf-btn" class="action-button bg-red-600 hover:bg-red-700">Xuất File PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview -->
        <div class="w-full lg:w-2/3 bg-gray-300">
            <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
        </div>
    </div>
    
    <template id="quote-template-source">
        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Báo giá - ${clientCompanyName}</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #F3F4F6; }
                @media print { 
                    body { background-color: #FFFFFF; } 
                    .print-container { 
                        box-shadow: none !important; 
                        margin: 0 !important; 
                        padding: 0 !important; 
                        border: none !important;
                    } 
                }
                :root { --bg-main: #FFFFFF; --bg-secondary: #F9FAFB; --border-subtle: #E5E7EB; --accent-main: #0D9488; --accent-secondary: #2563EB; --text-main: #1F2937; --text-secondary: #6B7280; }
                .highlight-accent { color: var(--accent-main); }
            </style>
        </head>
        <body class="p-4 sm:p-8">
            <div class="max-w-5xl mx-auto my-8 bg-white shadow-lg rounded-lg p-8 sm:p-12 print-container">
                <header class="flex justify-between items-start pb-8 border-b-2" style="border-color: var(--accent-main);">
                    <div class="text-sm" style="color: var(--text-secondary);">
                        <p class="font-bold text-base" style="color: var(--text-main);">SYNITY Co, Ltd</p>
                        <p>Số 96/54/8 đường Nguyễn Thông, Phường Nhiêu Lộc, TP. Hồ Chí Minh</p>
                        <p>MST: 0318972367</p>
                    </div>
                    <div><img src="https://placehold.co/120x40/0D9488/FFFFFF?text=SYNITY" alt="Logo SYNITY" class="h-10"></div>
                </header>
                <div class="text-center my-10">
                    <h1 class="text-3xl sm:text-4xl font-extrabold" style="color: var(--accent-main);">BÁO GIÁ</h1>
                    <p class="text-lg mt-2 font-semibold" style="color: var(--text-main);">Hệ Sinh Thái Giải Pháp Chuyển Đổi Số Toàn Diện</p>
                </div>
                <section class="grid grid-cols-1 sm:grid-cols-2 gap-8 text-sm mb-10">
                    <div class="bg-gray-50 p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-subtle);">
                        <h3 class="font-bold mb-2" style="color: var(--text-main);">Gửi đến:</h3>
                        <p class="font-semibold" style="color: var(--text-main);">${clientCompanyName}</p>
                        <p style="color: var(--text-secondary);"><b>Địa chỉ:</b> ${client_address}</p>
                        <p style="color: var(--text-secondary);"><b>MST:</b> ${client_tax_code}</p>
                        <hr class="my-2">
                        <p style="color: var(--text-secondary);"><b>Người liên hệ:</b> ${contact_name}</p>
                        <p style="color: var(--text-secondary);"><b>SĐT:</b> ${contact_phone}</p>
                        <p style="color: var(--text-secondary);"><b>Email:</b> ${contact_email}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-subtle);">
                        <div class="grid grid-cols-2 gap-y-1">
                            <p class="font-semibold self-center" style="color: var(--text-secondary);">Số báo giá:</p>
                            <p class="font-bold text-right break-words" style="color: var(--text-main);">${quotation_number}</p>
                            <p class="font-semibold" style="color: var(--text-secondary);">Ngày tạo:</p>
                            <p class="text-right" style="color: var(--text-main);">${date_created}</p>
                            <p class="font-semibold" style="color: var(--text-secondary);">Hiệu lực đến:</p>
                            <p class="text-right" style="color: var(--text-main);">${closed_date}</p>
                        </div>
                         <div class="border-t mt-3 pt-3 grid grid-cols-2" style="border-color: var(--border-subtle);">
                            <div><p class="font-semibold" style="color: var(--text-secondary);">Phụ trách:</p></div>
                             <div class="text-right">
                                <p class="font-bold" style="color: var(--text-main);">${responsiblePersonName}</p>
                                <p style="color: var(--text-main);">${responsiblePersonPhone}</p>
                                <p style="color: var(--text-main);">${responsiblePersonEmail}</p>
                            </div>
                        </div>
                    </div>
                </section>
                <p class="mb-8" style="color: var(--text-main);">
                    SYNITY kính gửi <span class="font-bold">Quý ${clientCompanyName}</span> bảng báo giá chi tiết cho HỆ SINH THÁI GIẢI PHÁP CHUYỂN ĐỔI SỐ TOÀN DIỆN SYNITY như sau:
                </p>
                <section class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3 font-semibold" style="color: var(--text-secondary);">STT</th>
                                <th class="p-3 font-semibold" style="color: var(--text-secondary);">HẠNG MỤC TRIỂN KHAI</th>
                                <th class="p-3 font-semibold text-right" style="color: var(--text-secondary);">ĐƠN GIÁ</th>
                                <th class="p-3 font-semibold text-center" style="color: var(--text-secondary);">SỐ LƯỢNG</th>
                                <th class="p-3 font-semibold text-right" style="color: var(--text-secondary);">THÀNH TIỀN (VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody style="color: var(--text-main);">
                            <!-- BITRIX_SECTION_PLACEHOLDER -->
                            <!-- BITRIX_DISCOUNT_ROW_PLACEHOLDER -->
                            <!-- IMPLEMENTATION_SECTION_PLACEHOLDER -->
                        </tbody>
                    </table>
                </section>
                <section class="mt-8 flex justify-end">
                    <div class="w-full sm:w-2/5 lg:w-2/5 bg-teal-50 p-4 rounded-lg border-l-4" style="border-color: var(--accent-main);">
                        <div class="text-sm">
                            <div class="flex justify-between py-2">
                                <span style="color: var(--text-secondary);">Tổng cộng (A+B):</span>
                                <span class="font-semibold" style="color: var(--text-main);">${sub_total}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span style="color: var(--text-secondary);">VAT (10%):</span>
                                <span class="font-semibold" style="color: var(--text-main);">${vat_amount}</span>
                            </div>
                            <div class="flex justify-between py-3 mt-2 border-t-2" style="border-color: var(--text-main);">
                                <span class="text-base font-bold" style="color: var(--text-main);">TỔNG THANH TOÁN:</span>
                                <span class="text-base font-bold" style="color: var(--accent-main);">${grand_total} VNĐ</span>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="mt-12 pt-8 border-t text-sm space-y-4" style="border-color: var(--border-subtle);">
                    <h4 class="font-bold text-lg" style="color: var(--text-main);">TIẾN ĐỘ THANH TOÁN</h4>
                    ${payment_schedule_table}
                    <p class="mt-2 text-sm italic text-gray-500">
                        * Thời hạn thanh toán chi tiết cho từng đợt sẽ được quy định cụ thể trong hợp đồng.
                    </p>
                </section>

                <section class="mt-8 pt-8 border-t text-sm space-y-6" style="border-color: var(--border-subtle);">
                    <div>
                        <h4 class="font-bold mb-2" style="color: var(--text-main);">ƯU ĐÃI VÀ KHUYẾN MÃI</h4>
                        ${discount_info}
                    </div>
                    <div>
                        <h4 class="font-bold mb-2" style="color: var(--text-main);">CHÍNH SÁCH BẢO HÀNH VÀ HỖ TRỢ</h4>
                        <ul class="list-disc list-inside space-y-1" style="color: var(--text-secondary);">
                            <li>Hỗ trợ và hướng dẫn sử dụng qua livechat, điện thoại, và gặp mặt trực tiếp.</li>
                            <li>Cam kết giải đáp các vấn đề, sự cố trong suốt quá trình sử dụng.</li>
                            <li>Cung cấp tài liệu hướng dẫn đầy đủ cho đội ngũ của Quý Công ty.</li>
                        </ul>
                    </div>
                </section>
                <footer class="mt-12 pt-8 text-center text-xs border-t" style="border-color: var(--border-subtle); color: var(--text-secondary);">
                    <p class="font-semibold" style="color: var(--text-main);">Cảm ơn sự quan tâm của Quý Công ty.</p>
                    <p>Nếu có bất kỳ câu hỏi nào, xin vui lòng liên hệ với chúng tôi qua:</p>
                    <div class="flex justify-center items-center space-x-4 mt-4">
                        <a href="mailto:${responsiblePersonEmail}" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                            Email
                        </a>
                        <a href="tel:${responsiblePersonPhone}" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                            Gọi điện
                        </a>
                    </div>
                    <p class="mt-4">SYNITY Co, Ltd</p>
                </footer>
            </div>
        </body>
        </html>
    </template>

    <script>
        /**
         * CHANGE LOG v1.4.3 (DRAFT)
         * --------------------
         * - Feature: Consolidated discount inputs - merged Bitrix and SYNITY discounts into single "Tổng ưu đãi" field
         * - Feature: Added toggle button to enable/disable implementation fee section "B. PHÍ TRIỂN KHAI & ĐỒNG HÀNH CHUYỂN ĐỔI SỐ"
         * - Feature: Added toggle button to enable/disable Bitrix license section "A. CHI PHÍ BẢN QUYỀN BITRIX24 - CLOUD"
         * - Logic: Simplified discount calculation logic - single discount percentage applied to license cost
         * - Logic: Conditional implementation fee - section only appears in quotation when toggle is enabled
         * - Logic: Conditional Bitrix license - section only appears in quotation when toggle is enabled
         * - UI: Cleaner interface with one discount input instead of two separate fields
         * - UI: Toggle switch with visual feedback for implementation fee inclusion
         * - UI: Toggle switch with visual feedback for Bitrix license inclusion
         * - Template: Updated quotation template to show single discount row instead of multiple discount rows
         * - Template: Dynamic implementation section rendering based on toggle state
         * - Template: Dynamic Bitrix license section rendering based on toggle state
         * - Maintenance: Reduced code complexity and improved maintainability
         * 
         * CHANGE LOG v1.4.2
         * --------------------
         * - Feature: Added customizable currency conversion fee percentage input
         * - Feature: Added Bitrix discount percentage separate from SYNITY discount
         * - Logic: Updated pricing formula to include both Bitrix and SYNITY discounts
         * - Logic: Auto-generate quotation number with format SYN-Q-YYMMDD-01
         * - UI: Reorganized discount fields for better clarity
         *
         * CHANGE LOG v1.4.1
         * --------------------
         * - Logic Update: Payment schedule is now calculated based on post-tax (VAT included) amounts to match the grand total.
         * - UI Update: Added "(đã bao gồm VAT)" note to the payment schedule descriptions for clarity.
         *
         * CHANGE LOG v1.4.0
         * --------------------
         * - Feature: Added "Export to PDF" button.
         * - Logic: Implemented exportPdf function using the browser's print functionality.
         * - UI: Added a new red button for PDF export and adjusted the action buttons layout.
         */
        document.addEventListener('DOMContentLoaded', () => {
            const QUOTATION_TEMPLATE = document.getElementById('quote-template-source').innerHTML;

            const bitrixPricingData = {
                "Bitrix24 Professional (12-Month)": { price: 249, months: 12 },
                "Bitrix24 Professional (3-Month)": { price: 249, months: 3 },
                "Bitrix24 Standard (12-Month)": { price: 124, months: 12 },
                "Bitrix24 Standard (3-Month)": { price: 124, months: 3 },
                "Bitrix24 Enterprise (12-Month)": { price: 499, months: 12 },
                "Bitrix24 Enterprise (3-Month)": { price: 499, months: 3 }
            };

            const inputs = {
                responsiblePersonName: document.getElementById('responsiblePersonName'),
                responsiblePersonPhone: document.getElementById('responsiblePersonPhone'),
                responsiblePersonEmail: document.getElementById('responsiblePersonEmail'),
                clientCompanyName: document.getElementById('clientCompanyName'),
                client_address: document.getElementById('client_address'),
                client_tax_code: document.getElementById('client_tax_code'),
                contact_name: document.getElementById('contact_name'),
                contact_phone: document.getElementById('contact_phone'),
                contact_email: document.getElementById('contact_email'),
                quotation_number: document.getElementById('quotation_number'),
                date_created: document.getElementById('date_created'),
                closed_date: document.getElementById('closed_date'),
                exchange_rate: document.getElementById('exchange_rate'),
                currency_conversion_fee_percent: document.getElementById('currency_conversion_fee_percent'),
                discount_percent: document.getElementById('discount_percent'),
                bitrix_version_select: document.getElementById('bitrix_version_select'),
                bitrix_price_usd: document.getElementById('bitrix_price_usd'),
                bitrix_months: document.getElementById('bitrix_months'),
                implementation_fee: document.getElementById('implementation_fee'),
                include_implementation_fee: document.getElementById('include_implementation_fee'),
                include_bitrix_license: document.getElementById('include_bitrix_license'),
            };
            const generateBtn = document.getElementById('generate-btn');
            const exportBtn = document.getElementById('export-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const previewFrame = document.getElementById('preview-frame');

            const paymentInstallmentsSelect = document.getElementById('payment_installments');
            const paymentSplitMethodRadios = document.querySelectorAll('input[name="payment_split_method"]');
            const installmentsDetailsContainer = document.getElementById('installments_details_container');
            const validationMessageDiv = document.getElementById('installments_validation_message');
            const mergePaymentsCheckbox = document.getElementById('merge_payments_checkbox');
            const implementationFeeContainer = document.getElementById('implementation_fee_container');
            const bitrixLicenseContainer = document.getElementById('bitrix_license_container');

            const formatCurrency = (num) => {
                if (isNaN(num)) return '0';
                return new Intl.NumberFormat('vi-VN').format(Math.round(num));
            };

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            const getFormValues = () => {
                const values = {};
                for (const key in inputs) {
                    if (inputs[key].type === 'checkbox') {
                        values[key] = inputs[key].checked;
                    } else {
                        values[key] = inputs[key].value;
                    }
                }
                return values;
            };

            const handleImplementationFeeToggle = () => {
                const isEnabled = inputs.include_implementation_fee.checked;
                
                if (isEnabled) {
                    implementationFeeContainer.classList.remove('toggle-disabled');
                    inputs.implementation_fee.disabled = false;
                } else {
                    implementationFeeContainer.classList.add('toggle-disabled');
                    inputs.implementation_fee.disabled = true;
                }
                
                validateInstallments();
                updatePreview();
            };

            const handleBitrixLicenseToggle = () => {
                const isEnabled = inputs.include_bitrix_license.checked;
                
                if (isEnabled) {
                    bitrixLicenseContainer.classList.remove('toggle-disabled');
                    inputs.bitrix_version_select.disabled = false;
                    inputs.bitrix_price_usd.disabled = false;
                    inputs.bitrix_months.disabled = false;
                } else {
                    bitrixLicenseContainer.classList.add('toggle-disabled');
                    inputs.bitrix_version_select.disabled = true;
                    inputs.bitrix_price_usd.disabled = true;
                    inputs.bitrix_months.disabled = true;
                }
                
                validateInstallments();
                updatePreview();
            };

            const renderInstallmentInputs = () => {
                const numInstallments = parseInt(paymentInstallmentsSelect.value);
                const splitMethod = document.querySelector('input[name="payment_split_method"]:checked').value;
                installmentsDetailsContainer.innerHTML = ''; 

                const defaultValues = [];
                if (numInstallments === 1) defaultValues.push(100);
                if (numInstallments === 2) defaultValues.push(50, 50);
                if (numInstallments === 3) defaultValues.push(50, 30, 20);

                for (let i = 1; i <= numInstallments; i++) {
                    const value = (splitMethod === 'percent') ? (defaultValues[i-1] || 0) : 0;
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 gap-2 items-center';
                    row.innerHTML = `
                        <label for="installment_${i}" class="font-medium">Đợt ${i} (${splitMethod === 'percent' ? '%' : 'VNĐ'})</label>
                        <input type="number" id="installment_${i}" class="installment-input" value="${value}" data-installment-index="${i}">
                        <input type="text" id="installment_value_${i}" class="installment-value p-2 rounded-md" readonly>
                    `;
                    installmentsDetailsContainer.appendChild(row);
                }
                validateInstallments();
            };

            const validateInstallments = () => {
                const implementationFee = parseFloat(inputs.implementation_fee.value) || 0;
                const splitMethod = document.querySelector('input[name="payment_split_method"]:checked').value;
                const installmentInputs = document.querySelectorAll('.installment-input');
                let total = 0;

                installmentInputs.forEach(input => {
                    const value = parseFloat(input.value) || 0;
                    total += value;
                    
                    const valueDisplay = document.getElementById(`installment_value_${input.dataset.installmentIndex}`);
                    if (splitMethod === 'percent') {
                        valueDisplay.value = formatCurrency(implementationFee * (value / 100)) + ' VNĐ';
                    } else {
                        const percent = implementationFee > 0 ? ((value / implementationFee) * 100).toFixed(1) : 0;
                        valueDisplay.value = `${percent}%`;
                    }
                });

                let isValid = false;
                if (splitMethod === 'percent') {
                    isValid = (total === 100);
                    validationMessageDiv.textContent = `Tổng: ${total.toFixed(2)}%`;
                } else {
                    isValid = (total === implementationFee);
                    validationMessageDiv.textContent = `Tổng: ${formatCurrency(total)} / ${formatCurrency(implementationFee)} VNĐ`;
                }

                validationMessageDiv.className = `text-sm font-semibold text-center p-2 rounded-md ${isValid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            };
            
            const handleVersionChange = () => {
                const selectedVersion = inputs.bitrix_version_select.value;
                const pricing = bitrixPricingData[selectedVersion];
                if (pricing) {
                    inputs.bitrix_price_usd.value = pricing.price;
                    inputs.bitrix_months.value = `${pricing.months} tháng`;
                }
                validateInstallments();
                updatePreview();
            };

            const generateQuote = () => {
                const data = getFormValues();

                const exchange_rate = parseFloat(data.exchange_rate) || 0;
                const include_bitrix_license = data.include_bitrix_license || false;
                const bitrix_price_usd = include_bitrix_license ? (parseFloat(data.bitrix_price_usd) || 0) : 0;
                const bitrix_months = include_bitrix_license ? (bitrixPricingData[data.bitrix_version_select]?.months || 0) : 0;
                const currency_conversion_fee_percent = parseFloat(data.currency_conversion_fee_percent) || 3;
                const discount_percent = parseFloat(data.discount_percent) || 0;
                const include_implementation_fee = data.include_implementation_fee || false;
                const implementation_fee = include_implementation_fee ? (parseFloat(data.implementation_fee) || 0) : 0;

                const bitrix_unit_price_vnd = bitrix_price_usd * exchange_rate;
                const bitrix_total_price_vnd = bitrix_unit_price_vnd * bitrix_months;
                const currency_conversion_fee = bitrix_total_price_vnd * (currency_conversion_fee_percent / 100);
                const total_discount_amount = bitrix_total_price_vnd * (discount_percent / 100);

                const total_license_fee_A = bitrix_total_price_vnd + currency_conversion_fee - total_discount_amount;
                const total_implementation_fee_B = implementation_fee;
                
                const sub_total = total_license_fee_A + total_implementation_fee_B;
                const vat_amount = sub_total * 0.10;
                const grand_total = sub_total + vat_amount;

                const post_tax_A = total_license_fee_A * 1.1;
                const post_tax_B = total_implementation_fee_B * 1.1;

                let paymentScheduleTable = '';
                const installmentInputs = document.querySelectorAll('.installment-input');
                const splitMethod = document.querySelector('input[name="payment_split_method"]:checked').value;
                const isMerged = mergePaymentsCheckbox.checked;
                
                let scheduleRows = '';
                let installmentValues = Array.from(installmentInputs).map(i => parseFloat(i.value) || 0);

                if (isMerged) {
                    let firstInstallmentB_post_tax = 0;
                    if (splitMethod === 'percent') {
                        firstInstallmentB_post_tax = post_tax_B * (installmentValues[0] / 100);
                    } else {
                        firstInstallmentB_post_tax = installmentValues[0] * 1.1;
                    }
                    const firstInstallmentTotal = post_tax_A + firstInstallmentB_post_tax;
                    scheduleRows += `
                        <tr class="bg-gray-50 border-b">
                            <td class="p-3 font-semibold">Đợt 1</td>
                            <td class="p-3">Thanh toán 100% Phí bản quyền (A) và ${installmentValues[0]}${splitMethod === 'percent' ? '%' : ' VNĐ'} Phí triển khai (B)</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(firstInstallmentTotal)}</td>
                        </tr>`;
                    
                    for(let i = 1; i < installmentValues.length; i++) {
                        let installmentAmountB_post_tax = 0;
                        if (splitMethod === 'percent') {
                            installmentAmountB_post_tax = post_tax_B * (installmentValues[i] / 100);
                        } else {
                            installmentAmountB_post_tax = installmentValues[i] * 1.1;
                        }
                        scheduleRows += `
                        <tr class="border-b">
                            <td class="p-3 font-semibold">Đợt ${i + 1}</td>
                            <td class="p-3">Thanh toán ${installmentValues[i]}${splitMethod === 'percent' ? '%' : ' VNĐ'} Phí triển khai (B)</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(installmentAmountB_post_tax)}</td>
                        </tr>`;
                    }
                } else {
                    scheduleRows += `
                        <tr class="bg-gray-50 border-b">
                            <td class="p-3 font-semibold">Đợt 1</td>
                            <td class="p-3">Thanh toán 100% Phí bản quyền (A)</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(post_tax_A)}</td>
                        </tr>`;
                    
                    for(let i = 0; i < installmentValues.length; i++) {
                        let installmentAmountB_post_tax = 0;
                        if (splitMethod === 'percent') {
                            installmentAmountB_post_tax = post_tax_B * (installmentValues[i] / 100);
                        } else {
                            installmentAmountB_post_tax = installmentValues[i] * 1.1;
                        }
                        scheduleRows += `
                        <tr class="${i % 2 !== 0 ? 'bg-gray-50' : ''} border-b">
                            <td class="p-3 font-semibold">Đợt ${i + 2}</td>
                            <td class="p-3">Thanh toán ${installmentValues[i]}${splitMethod === 'percent' ? '%' : ' VNĐ'} Phí triển khai (B)</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(installmentAmountB_post_tax)}</td>
                        </tr>`;
                    }
                }

                paymentScheduleTable = `
                    <table class="w-full text-sm text-left border rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3 font-semibold" style="color: var(--text-secondary);">ĐỢT</th>
                                <th class="p-3 font-semibold" style="color: var(--text-secondary);">NỘI DUNG</th>
                                <th class="p-3 font-semibold text-right" style="color: var(--text-secondary);">SỐ TIỀN (VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${scheduleRows}
                        </tbody>
                    </table>
                `;

                // Generate discount row if applicable (only when Bitrix license is enabled)
                let discount_row = '';
                if (include_bitrix_license && discount_percent > 0 && total_discount_amount > 0) {
                    discount_row = `<tr class="border-b" style="border-color: var(--border-subtle);">
                                <td class="p-3 text-center">3</td>
                                <td class="p-3">
                                    <p class="font-semibold" style="color: var(--accent-main);">Ưu đãi SYNITY (${discount_percent}%)</p>
                                </td>
                                <td class="p-3 text-right"></td>
                                <td class="p-3 text-center">1</td>
                                <td class="p-3 text-right font-semibold" style="color: var(--accent-main);">(${formatCurrency(total_discount_amount)})</td>
                            </tr>`;
                }

                // Generate discount info for promotions section
                let discount_info = '';
                if (include_bitrix_license && discount_percent > 0) {
                    discount_info = `<p style="color: var(--text-secondary);">Ưu đãi từ SYNITY: <strong style="color: var(--accent-main);">Giảm ${discount_percent}%</strong> chi phí bản quyền Bitrix24 trong ${bitrix_months} tháng.</p>`;
                }

                // Generate Bitrix license section if enabled
                let bitrix_section = '';
                if (include_bitrix_license && bitrix_total_price_vnd > 0) {
                    bitrix_section = `<tr class="bg-blue-50"><td class="p-3 font-bold text-blue-800" colspan="5">A. CHI PHÍ BẢN QUYỀN BITRIX24 - CLOUD</td></tr>
                            <tr class="border-b" style="border-color: var(--border-subtle);">
                                <td class="p-3 text-center">1</td>
                                <td class="p-3">
                                    <p class="font-semibold">${data.bitrix_version_select}</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">Đơn vị tính: $${bitrix_price_usd}/tháng</p>
                                </td>
                                <td class="p-3 text-right">${formatCurrency(bitrix_unit_price_vnd)}</td>
                                <td class="p-3 text-center">${bitrix_months}</td>
                                <td class="p-3 text-right font-semibold">${formatCurrency(bitrix_total_price_vnd)}</td>
                            </tr>
                            <tr class="bg-gray-50 border-b" style="border-color: var(--border-subtle);">
                                <td class="p-3 text-center">2</td>
                                <td class="p-3">
                                    <p class="font-semibold">Phí chuyển đổi ngoại tệ (${currency_conversion_fee_percent}%)</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">Tỷ giá USD dự kiến: ${formatCurrency(exchange_rate)} VNĐ</p>
                                </td>
                                <td class="p-3 text-right"></td>
                                <td class="p-3 text-center">1</td>
                                <td class="p-3 text-right font-semibold">${formatCurrency(currency_conversion_fee)}</td>
                            </tr>`;
                }

                // Generate implementation section if enabled
                let implementation_section = '';
                if (include_implementation_fee && implementation_fee > 0) {
                    implementation_section = `<tr class="bg-blue-50"><td class="p-3 font-bold text-blue-800" colspan="5">B. PHÍ TRIỂN KHAI & ĐỒNG HÀNH CHUYỂN ĐỔI SỐ</td></tr>
                            <tr class="bg-gray-50 border-b" style="border-color: var(--border-subtle);">
                                <td class="p-3 text-center align-top">4</td>
                                <td class="p-3">
                                    <p class="font-semibold">Gói "Đồng Hành & Chia Sẻ Thành Công"</p>
                                    <ol class="list-decimal list-inside text-xs mt-2 space-y-1 pl-2" style="color: var(--text-secondary);">
                                        <li>Cố vấn Chiến lược Công nghệ - CTO as a Service™</li>
                                        <li>Giao tiếp & Cộng tác 4.0 - AI CoPilot Hỗ trợ</li>
                                        <li>Triển khai Bitrix24 CRM - Cỗ máy Bán hàng Tinh nhuệ</li>
                                        <li>Nền tảng Dữ liệu Hợp nhất - Single Source of Truth</li>
                                        <li>Tự động hóa Quy trình Toàn diện - Automation Ecosystem™</li>
                                        <li>Khai phóng Sức mạnh AI Agents - "Bộ Não Thứ Hai"</li>
                                        <li>Hệ thống Báo cáo Quản trị Thông minh (BI Dashboard)</li>
                                        <li>Bảo trì & Phát triển Liên tục - Evolution System™</li>
                                        <li>Truy cập Mạng lưới Chuyên gia SYNITY</li>
                                    </ol>
                                </td>
                                <td class="p-3 text-right align-top"></td>
                                <td class="p-3 text-center align-top">1</td>
                                <td class="p-3 text-right font-semibold align-top">${formatCurrency(implementation_fee)}</td>
                            </tr>`;
                }

                const templateData = {
                    ...data,
                    bitrix_months: bitrix_months,
                    date_created: formatDate(data.date_created),
                    closed_date: formatDate(data.closed_date),
                    exchange_rate_formatted: formatCurrency(exchange_rate),
                    bitrix_unit_price_vnd: formatCurrency(bitrix_unit_price_vnd),
                    bitrix_total_price_vnd: formatCurrency(bitrix_total_price_vnd),
                    currency_conversion_fee: formatCurrency(currency_conversion_fee),
                    total_discount_amount: formatCurrency(total_discount_amount),
                    discount_info: discount_info,
                    implementation_fee: formatCurrency(implementation_fee),
                    include_implementation_fee: include_implementation_fee,
                    include_bitrix_license: include_bitrix_license,
                    sub_total: formatCurrency(sub_total),
                    vat_amount: formatCurrency(vat_amount),
                    grand_total: formatCurrency(grand_total),
                    payment_schedule_table: paymentScheduleTable,
                    // UPDATE v1.4.2: Pass post-tax totals for A and B
                    total_A_post_tax: formatCurrency(post_tax_A),
                    total_B_post_tax: formatCurrency(post_tax_B),
                };

                let finalHtml = QUOTATION_TEMPLATE;
                for (const key in templateData) {
                    finalHtml = finalHtml.replace(new RegExp(`\\\$\\\{${key}\\\}`, 'g'), templateData[key]);
                }
                
                // Replace the Bitrix section placeholder
                finalHtml = finalHtml.replace('<!-- BITRIX_SECTION_PLACEHOLDER -->', bitrix_section);
                
                // Replace the discount row placeholder
                finalHtml = finalHtml.replace('<!-- BITRIX_DISCOUNT_ROW_PLACEHOLDER -->', discount_row);
                
                // Replace the implementation section placeholder
                finalHtml = finalHtml.replace('<!-- IMPLEMENTATION_SECTION_PLACEHOLDER -->', implementation_section);
                
                return finalHtml;
            };

            const updatePreview = () => {
                const finalHtml = generateQuote();
                previewFrame.srcdoc = finalHtml;
            };

            const exportHtmlFile = () => {
                const finalHtml = generateQuote();
                const blob = new Blob([finalHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const clientName = inputs.clientCompanyName.value.replace(/ /g, '_') || 'KhachHang';
                a.download = `BaoGia-${clientName}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const exportPdf = () => {
                const preview = previewFrame.contentWindow;
                if (preview) {
                    preview.focus();
                    preview.print();
                }
            };

            const generateQuotationNumber = () => {
                const today = new Date();
                const year = today.getFullYear().toString().slice(-2);
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `SYN-Q-${year}${month}${day}-01`;
            };

            const init = () => {
                const today = new Date();
                inputs.date_created.valueAsDate = today;
                const thirtyDaysLater = new Date();
                thirtyDaysLater.setDate(today.getDate() + 30);
                inputs.closed_date.valueAsDate = thirtyDaysLater;
                
                // Set auto-generated quotation number
                inputs.quotation_number.value = generateQuotationNumber();

                for (const version in bitrixPricingData) {
                    const option = document.createElement('option');
                    option.value = version;
                    option.textContent = version;
                    inputs.bitrix_version_select.appendChild(option);
                }
                inputs.bitrix_version_select.value = "Bitrix24 Professional (12-Month)";

                generateBtn.addEventListener('click', updatePreview);
                exportBtn.addEventListener('click', exportHtmlFile);
                exportPdfBtn.addEventListener('click', exportPdf);
                
                paymentInstallmentsSelect.addEventListener('change', renderInstallmentInputs);
                paymentSplitMethodRadios.forEach(radio => radio.addEventListener('change', renderInstallmentInputs));
                installmentsDetailsContainer.addEventListener('input', validateInstallments);
                inputs.implementation_fee.addEventListener('input', validateInstallments);
                inputs.bitrix_version_select.addEventListener('change', handleVersionChange);
                inputs.include_implementation_fee.addEventListener('change', handleImplementationFeeToggle);
                inputs.include_bitrix_license.addEventListener('change', handleBitrixLicenseToggle);

                handleVersionChange(); 
                renderInstallmentInputs();
            };

            init();
        });
    </script>

</body>
</html>
